# è®¾å¤‡æŠ¥ä¿®ç³»ç»Ÿéƒ¨ç½²æŒ‡å—

## ä¸€ã€é£ä¹¦/é’‰é’‰æ¶ˆæ¯æ¨é€åŠŸèƒ½

### 1.1 é£ä¹¦æœºå™¨äººæ¨é€æ–¹æ¡ˆ

#### å®ç°æ­¥éª¤ï¼š
1. **åˆ›å»ºé£ä¹¦ç¾¤ç»„å’Œæœºå™¨äºº**
   - åœ¨é£ä¹¦ä¸­åˆ›å»ºç»´ä¿®ç»„ç¾¤ç»„
   - åœ¨ç¾¤ç»„ä¸­æ·»åŠ "è‡ªå®šä¹‰æœºå™¨äºº"
   - è®°å½•æœºå™¨äººçš„ Webhook URL

2. **åç«¯é…ç½®**
   - åœ¨ `backend/.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š
   ```
   FEISHU_WEBHOOK_URL=ä½ çš„é£ä¹¦æœºå™¨äººWebhookåœ°å€
   ```

3. **ä»£ç å®ç°æ€è·¯**
   ```javascript
   // åœ¨åç«¯æ–°å¢é£ä¹¦æ¨é€æœåŠ¡
   const sendFeishuNotification = async (repairData) => {
     const webhook = process.env.FEISHU_WEBHOOK_URL;
     const message = {
       msg_type: "interactive",
       card: {
         config: { wide_screen_mode: true },
         elements: [
           {
             tag: "div",
             text: {
               tag: "lark_md",
               content: `ğŸ“‹ **æ–°è®¾å¤‡æŠ¥ä¿®é€šçŸ¥**

**è®¾å¤‡åç§°**: ${repairData.equipment_name}
**æŠ¥ä¿®å†…å®¹**: ${repairData.description}
**ç´§æ€¥ç¨‹åº¦**: ${repairData.priority}
**æŠ¥ä¿®äºº**: ${repairData.requester_name}
**æŠ¥ä¿®æ—¶é—´**: ${repairData.created_at}`
             }
           }
         ]
       }
     };
     
     await axios.post(webhook, message);
   };
   ```

4. **è§¦å‘æ—¶æœº**
   - åœ¨ `repairRequestRoutes.js` ä¸­åˆ›å»ºæ–°æŠ¥ä¿®åè°ƒç”¨é€šçŸ¥å‡½æ•°
   - å¯ä»¥è®¾ç½®ä¸ºç«‹å³æ¨é€æˆ–å®šæ—¶æ‰¹é‡æ¨é€

### 1.2 é’‰é’‰æœºå™¨äººæ¨é€æ–¹æ¡ˆ

#### å®ç°æ­¥éª¤ï¼š
1. **åˆ›å»ºé’‰é’‰ç¾¤ç»„å’Œæœºå™¨äºº**
   - åœ¨é’‰é’‰ä¸­åˆ›å»ºç»´ä¿®ç»„ç¾¤ç»„
   - åœ¨ç¾¤ç»„ä¸­æ·»åŠ "è‡ªå®šä¹‰æœºå™¨äºº"
   - è®°å½•æœºå™¨äººçš„ Webhook URL å’ŒåŠ ç­¾å¯†é’¥

2. **åç«¯é…ç½®**
   ```bash
   DINGTALK_WEBHOOK_URL=ä½ çš„é’‰é’‰æœºå™¨äººWebhookåœ°å€
   DINGTALK_SECRET=ä½ çš„é’‰é’‰æœºå™¨äººåŠ ç­¾å¯†é’¥
   ```

3. **ä»£ç å®ç°æ€è·¯**
   ```javascript
   const sendDingtalkNotification = async (repairData) => {
     const webhook = process.env.DINGTALK_WEBHOOK_URL;
     const secret = process.env.DINGTALK_SECRET;
     
     const timestamp = Date.now();
     const stringToSign = timestamp + '\n' + secret;
     const hash = crypto.createHmac('sha256', secret)
                        .update(stringToSign)
                        .digest('base64');
     const sign = encodeURIComponent(hash);
     
     const message = {
       msgtype: "markdown",
       markdown: {
         title: "è®¾å¤‡æŠ¥ä¿®é€šçŸ¥",
         text: `## ğŸ“‹ æ–°è®¾å¤‡æŠ¥ä¿®

**è®¾å¤‡åç§°**: ${repairData.equipment_name}
**æŠ¥ä¿®å†…å®¹**: ${repairData.description}
**ç´§æ€¥ç¨‹åº¦**: ${repairData.priority}
**æŠ¥ä¿®äºº**: ${repairData.requester_name}
**æŠ¥ä¿®æ—¶é—´**: ${repairData.created_at}`
       },
       at: {
         atMobiles: [ç»´ä¿®ç»„äººå‘˜æ‰‹æœºå·],
         isAtAll: false
       }
     };
     
     await axios.post(`${webhook}&timestamp=${timestamp}&sign=${sign}`, message);
   };
   ```

### 1.3 æ¶ˆæ¯æ¨é€æœ€ä½³å®è·µ

1. **æ¶ˆæ¯åˆ†çº§æ¨é€**
   - ç´§æ€¥æŠ¥ä¿®ï¼šç«‹å³æ¨é€
   - ä¸€èˆ¬æŠ¥ä¿®ï¼šæ¯å°æ—¶æ‰¹é‡æ¨é€
   - ç»´ä¿®å®Œæˆï¼šæ¨é€é€šçŸ¥æŠ¥ä¿®äºº

2. **æ¨é€å†…å®¹ä¼˜åŒ–**
   - åŒ…å«è®¾å¤‡ç…§ç‰‡ï¼ˆå¦‚æœ‰ï¼‰
   - è®¾å¤‡ä½ç½®ä¿¡æ¯
   - å†å²ç»´ä¿®è®°å½•é“¾æ¥
   - å¤„ç†è¿›åº¦è¿½è¸ª

3. **å¤±è´¥é‡è¯•æœºåˆ¶**
   - æ¨é€å¤±è´¥æ—¶è®°å½•æ—¥å¿—
   - æ”¯æŒæ‰‹åŠ¨é‡å‘
   - ç›‘æ§æ¨é€æˆåŠŸç‡

---

## äºŒã€å¤–ç½‘éƒ¨ç½²æ–¹æ¡ˆ

### 2.1 äº‘æœåŠ¡å™¨éƒ¨ç½²ï¼ˆæ¨èï¼‰

#### æœåŠ¡å™¨è¦æ±‚ï¼š
- **é…ç½®**: 2æ ¸4Gå†…å­˜ï¼Œ40Gç¡¬ç›˜
- **ç³»ç»Ÿ**: CentOS 7+ æˆ– Ubuntu 18.04+
- **ç½‘ç»œ**: å›ºå®šå…¬ç½‘IPï¼Œå¸¦å®½è‡³å°‘5Mbps

#### éƒ¨ç½²æ­¥éª¤ï¼š

**1. æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡**
```bash
# æ›´æ–°ç³»ç»Ÿ
sudo yum update -y  # CentOS
# sudo apt update && sudo apt upgrade -y  # Ubuntu

# å®‰è£…Node.js
curl -fsSL https://rpm.nodesource.com/setup_16.x | sudo bash -
sudo yum install -y nodejs

# å®‰è£…PM2è¿›ç¨‹ç®¡ç†å™¨
sudo npm install -g pm2

# å®‰è£…Nginx
sudo yum install -y nginx  # CentOS
# sudo apt install -y nginx  # Ubuntu

# å®‰è£…MySQL
sudo yum install -y mysql-server  # CentOS
# sudo apt install -y mysql-server  # Ubuntu
```

**2. é¡¹ç›®éƒ¨ç½²**
```bash
# 1. ä¸Šä¼ é¡¹ç›®åˆ°æœåŠ¡å™¨ï¼ˆä½¿ç”¨scpæˆ–git cloneï¼‰
scp -r /path/to/project user@server:/opt/iampro/

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/iampro

# 3. å®‰è£…åç«¯ä¾èµ–
cd backend
npm install

# 4. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘.envæ–‡ä»¶ï¼Œé…ç½®æ•°æ®åº“è¿æ¥ç­‰

# 5. å®‰è£…å‰ç«¯ä¾èµ–å¹¶æ„å»º
cd ../frontend
npm install
npm run build

# 6. å°†æ„å»ºç»“æœå¤åˆ¶åˆ°åç«¯publicç›®å½•
cp -r dist/* ../backend/public/
```

**3. æ•°æ®åº“é…ç½®**
```bash
# å¯åŠ¨MySQL
sudo systemctl start mysql
sudo systemctl enable mysql

# åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
mysql -u root -p
CREATE DATABASE iampro CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'iampro'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON iampro.* TO 'iampro'@'localhost';
FLUSH PRIVILEGES;
```

**4. é…ç½®PM2å¯åŠ¨åç«¯**
```bash
# åœ¨backendç›®å½•åˆ›å»ºecosystem.config.js
module.exports = {
  apps: [{
    name: 'iampro-backend',
    script: './server.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3001
    }
  }]
};
```

```bash
# å¯åŠ¨åç«¯æœåŠ¡
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

**5. é…ç½®Nginxåå‘ä»£ç†**
```nginx
# /etc/nginx/conf.d/iampro.conf
server {
    listen 80;
    server_name your-domain.com;  # æ›¿æ¢ä¸ºä½ çš„åŸŸå

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /opt/iampro/backend/public;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    # åç«¯APIä»£ç†
    location /api/ {
        proxy_pass http://localhost:3001/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # æ–‡ä»¶ä¸Šä¼ 
    location /uploads/ {
        proxy_pass http://localhost:3001/uploads/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

**6. å¯åŠ¨Nginx**
```bash
sudo systemctl start nginx
sudo systemctl enable nginx
sudo nginx -t
sudo systemctl reload nginx
```

### 2.2 åŸŸåå’ŒSSLé…ç½®

**1. åŸŸåè§£æ**
- å°†åŸŸåAè®°å½•æŒ‡å‘æœåŠ¡å™¨IPåœ°å€
- é…ç½®wwwå­åŸŸå

**2. SSLè¯ä¹¦ç”³è¯·ï¼ˆLet's Encryptå…è´¹ï¼‰**
```bash
# å®‰è£…Certbot
sudo yum install -y certbot python3-certbot-nginx

# ç”³è¯·SSLè¯ä¹¦
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# è®¾ç½®è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ ä»¥ä¸‹è¡Œï¼š
0 12 * * * /usr/bin/certbot renew --quiet
```

### 2.3 é˜²ç«å¢™é…ç½®
```bash
# å¼€æ”¾å¿…è¦ç«¯å£
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --permanent --add-port=3001/tcp
sudo firewall-cmd --reload
```

### 2.4 Dockeréƒ¨ç½²æ–¹æ¡ˆï¼ˆå¤‡é€‰ï¼‰

**1. åˆ›å»ºDockerfile**

åç«¯ Dockerfile:
```dockerfile
FROM node:16-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install --production
COPY . .
EXPOSE 3001
CMD ["node", "server.js"]
```

å‰ç«¯ Dockerfile:
```dockerfile
FROM node:16-alpine as build
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
```

**2. Docker Composeé…ç½®**
```yaml
version: '3.8'
services:
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend

  backend:
    build: ./backend
    ports:
      - "3001:3001"
    environment:
      - DB_HOST=mysql
      - DB_USER=iampro
      - DB_PASSWORD=password
      - DB_NAME=iampro
    depends_on:
      - mysql

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: iampro
      MYSQL_USER: iampro
      MYSQL_PASSWORD: password
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"

volumes:
  mysql_data:
```

**3. éƒ¨ç½²å‘½ä»¤**
```bash
docker-compose up -d
```

### 2.5 ç›‘æ§å’Œç»´æŠ¤

**1. ç³»ç»Ÿç›‘æ§**
```bash
# å®‰è£…htopå’Œiotop
sudo yum install -y htop iotop

# è®¾ç½®ç³»ç»Ÿç›‘æ§è„šæœ¬
*/5 * * * * /usr/local/bin/check_services.sh
```

**2. æ—¥å¿—ç®¡ç†**
```bash
# é…ç½®æ—¥å¿—è½®è½¬
sudo nano /etc/logrotate.d/iampro

/opt/iampro/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 0644 app app
    postrotate
        pm2 reloadLogs
    endscript
}
```

**3. å¤‡ä»½ç­–ç•¥**
```bash
# æ•°æ®åº“å¤‡ä»½è„šæœ¬
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u iampro -p'your_password' iampro > /backup/iampro_$DATE.sql
find /backup -name "iampro_*.sql" -mtime +7 -delete

# é¡¹ç›®æ–‡ä»¶å¤‡ä»½
tar -czf /backup/iampro_project_$DATE.tar.gz /opt/iampro
find /backup -name "iampro_project_*.tar.gz" -mtime +7 -delete
```

**4. å¸¸è§é—®é¢˜æ’æŸ¥**
- ç«¯å£å ç”¨ï¼š`sudo netstat -tlnp | grep :3001`
- è¿›ç¨‹çŠ¶æ€ï¼š`pm2 status`
- é”™è¯¯æ—¥å¿—ï¼š`pm2 logs iampro-backend`
- æ•°æ®åº“è¿æ¥ï¼š`mysql -u iampro -p`

---

## ä¸‰ã€æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 3.1 æ•°æ®åº“ä¼˜åŒ–
```sql
-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_equipment_category ON equipment(category);
CREATE INDEX idx_repair_status ON repair_requests(status);
CREATE INDEX idx_repair_created ON repair_requests(created_at);
```

### 3.2 å‰ç«¯ä¼˜åŒ–
- å¯ç”¨Gzipå‹ç¼©
- é…ç½®CDNåŠ é€Ÿ
- å›¾ç‰‡æ‡’åŠ è½½
- æ¥å£ç¼“å­˜ç­–ç•¥

### 3.3 æœåŠ¡å™¨ä¼˜åŒ–
- å¯ç”¨HTTP/2
- é…ç½®Redisç¼“å­˜
- ä½¿ç”¨è´Ÿè½½å‡è¡¡ï¼ˆå¦‚æœ‰å¤šå°æœåŠ¡å™¨ï¼‰
- å®šæœŸæ¸…ç†æ—¥å¿—å’Œä¸´æ—¶æ–‡ä»¶

---

## å››ã€å®‰å…¨å»ºè®®

1. **æ•°æ®åº“å®‰å…¨**
   - ä¿®æ”¹é»˜è®¤ç«¯å£
   - ä½¿ç”¨å¼ºå¯†ç 
   - é™åˆ¶è¿œç¨‹è¿æ¥

2. **æœåŠ¡å™¨å®‰å…¨**
   - ç¦ç”¨rootè¿œç¨‹ç™»å½•
   - é…ç½®SSHå¯†é’¥è®¤è¯
   - å®šæœŸæ›´æ–°ç³»ç»Ÿè¡¥ä¸

3. **åº”ç”¨å®‰å…¨**
   - ä½¿ç”¨HTTPS
   - é…ç½®CORSç­–ç•¥
   - è¾“å…¥éªŒè¯å’Œè¿‡æ»¤
   - JWT tokenè¿‡æœŸæœºåˆ¶

---

é€šè¿‡ä»¥ä¸Šé…ç½®ï¼Œæ‚¨çš„è®¾å¤‡æŠ¥ä¿®ç³»ç»Ÿå³å¯æˆåŠŸéƒ¨ç½²åˆ°å¤–ç½‘ï¼Œæ”¯æŒé£ä¹¦/é’‰é’‰æ¶ˆæ¯æ¨é€åŠŸèƒ½ã€‚